input {
  file {
    path => "/var/log/app/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => multiline {
      pattern => "^\[agent"
      negate => true
      what => "previous"
    }
  }
}

filter {
  grok {
    match => [
      "message",
      "\[%{WORD:agent}-%{INT:agent_id}\] %{INT:timestamp}\nCPU: %{NUMBER:cpu}%% \| Memory: %{NUMBER:memory}%%\nDisk: R=%{NUMBER:disk_read}MB/s W=%{NUMBER:disk_write}MB/s\nNetwork: In=%{NUMBER:net_in}MB/s Out=%{NUMBER:net_out}MB/s"
    ]
  }

  mutate {
    convert => {
      "cpu"       => "float"
      "memory"    => "float"
      "disk_read" => "float"
      "disk_write"=> "float"
      "net_in"    => "float"
      "net_out"   => "float"
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "agent-metrics"
  }

  stdout { codec => rubydebug }
}
